import streamlit as st
import pandas as pd
import feedparser
import urllib.parse
from datetime import datetime
import time
from duckduckgo_search import DDGS
from pytrends.request import TrendReq

# --- 1. é é¢è¨­å®š (å¿…é ˆæ”¾åœ¨ç¬¬ä¸€è¡Œ) ---
st.set_page_config(page_title="å…¨çƒå»šé›»æƒ…å ±ä¸­å¿ƒ", page_icon="ğŸ³", layout="wide")

# --- 2. Session State åˆå§‹åŒ– ---
if 'favorites' not in st.session_state:
    st.session_state.favorites = pd.DataFrame(columns=['Folder', 'Date', 'Title', 'Link', 'Source'])

if 'folder_list' not in st.session_state:
    st.session_state.folder_list = ["ğŸ“¥ æœªåˆ†é¡", "ğŸ”¥ æ–¹å¤ª (Fotile)", "ğŸ”¥ è€é—† (Robam)", "ğŸ‡ªğŸ‡º æ­ç³»å“ç‰Œ", "ğŸ‡ºğŸ‡¸ ç¾ç³»å“ç‰Œ"]

if 'search_results' not in st.session_state:
    st.session_state.search_results = pd.DataFrame()

# --- 3. çˆ¬èŸ²å‡½æ•¸ç¾¤ ---

# A. Google News
def fetch_google_news(keyword, lang, region):
    search_query = keyword
    target_gl = region
    try:
        target_ceid = f"{region}:{lang.split('-')[0]}"
    except:
        target_ceid = f"{region}:en"

    if (region in ["US", "CA"]) and ("zh" in lang):
        if region == "US": search_query = f"{keyword} (ç¾åœ‹ OR åŒ—ç¾ OR USA)"
        elif region == "CA": search_query = f"{keyword} (åŠ æ‹¿å¤§ OR Canada OR æ¸©å“¥å OR å¤šä¼¦å¤š)"
        target_gl = "TW"
        target_ceid = "TW:zh-Hant"

    if region == "HK" and "zh" in lang:
        target_ceid = "HK:zh-Hant"
        target_gl = "HK"

    encoded_keyword = urllib.parse.quote(search_query)
    target_url = f"https://news.google.com/rss/search?q={encoded_keyword}&hl={lang}&gl={target_gl}&ceid={target_ceid}"
    
    try:
        feed = feedparser.parse(target_url)
        data = []
        if feed.entries:
            for entry in feed.entries:
                try: pub_date = datetime(*entry.published_parsed[:6])
                except: pub_date = datetime.now()
                data.append({
                    "Select": False,
                    "Date": pub_date,
                    "Type": "ğŸ“° æ–°è",
                    "Title": entry.title,
                    "Source": entry.source.title if 'source' in entry else "Google News",
                    "Link": entry.link
                })
            return pd.DataFrame(data)
        else:
            return pd.DataFrame()
    except Exception as e:
        return pd.DataFrame()

# B. DuckDuckGo
def fetch_web_search(keyword, region_code, time_range, platform_mode=None):
    if region_code == "US": ddg_region = "us-en"
    elif region_code == "CA": ddg_region = "ca-en"
    elif region_code == "HK": ddg_region = "hk-tzh"
    else: ddg_region = "wt-wt"
    
    ddg_time = None 
    if time_range == "éå»ä¸€å¤©": ddg_time = "d"
    elif time_range == "éå»ä¸€é€±": ddg_time = "w"
    elif time_range == "éå»ä¸€å€‹æœˆ": ddg_time = "m"
    elif time_range == "éå»ä¸€å¹´": ddg_time = "y"
    
    final_keyword = keyword
    search_region = ddg_region
